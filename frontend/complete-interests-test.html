<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Database Interests Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { 
            background: white; 
            border: 1px solid #ddd; 
            margin: 15px 0; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 5px solid #28a745; }
        .error { border-left: 5px solid #dc3545; }
        .loading { border-left: 5px solid #ffc107; }
        .interest-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px; 
            margin-top: 15px;
        }
        .interest-category {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
        }
        .interest-category h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .interest-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .interest-tag {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            overflow-x: auto; 
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        button { 
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px; 
            margin: 5px; 
            cursor: pointer; 
            border-radius: 4px;
        }
        button:hover { background: #0056b3; }
        .contact-card {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .contact-name { font-size: 18px; font-weight: bold; color: #343a40; }
        .stats { display: flex; gap: 20px; margin: 15px 0; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: #007bff; }
        .stat-label { color: #6c757d; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è Complete Database Interests Verification</h1>
        <p>This page tests the complete database-driven interests system with all enhanced interests.</p>
        
        <div class="stats" id="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalInterests">0</div>
                <div class="stat-label">Total Interests</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalCategories">0</div>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalContacts">0</div>
                <div class="stat-label">Contacts</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalAssignments">0</div>
                <div class="stat-label">Assignments</div>
            </div>
        </div>

        <div class="test-section loading" id="database-status">
            <h3>üîó Database Connection Status</h3>
            <p>Checking backend server and database connectivity...</p>
            <div id="database-result"></div>
        </div>

        <div class="test-section loading" id="interests-overview">
            <h3>üéÆ All Available Interests from Database</h3>
            <p>Loading complete interests catalog from enhanced database structure...</p>
            <div id="interests-result"></div>
        </div>

        <div class="test-section loading" id="contacts-overview">
            <h3>üë• Contact Interest Assignments</h3>
            <p>Loading individual contact interest assignments from database...</p>
            <div id="contacts-result"></div>
        </div>

        <div class="test-section" id="verification-controls">
            <h3>üîç Verification Controls</h3>
            <button onclick="verifyAllInterests()">üîÑ Refresh All Data</button>
            <button onclick="testContactSpecific(1)">Test Kathy</button>
            <button onclick="testContactSpecific(2)">Test Michael</button>
            <button onclick="testContactSpecific(3)">Test Nathan</button>
            <button onclick="testContactSpecific(4)">Test Willie</button>
            <button onclick="testContactSpecific(5)">Test Scarlett</button>
            <div id="verification-result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let globalInterests = null;
        let globalContacts = null;
        
        async function checkDatabaseConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                const section = document.getElementById('database-status');
                const result = document.getElementById('database-result');
                
                if (data.success) {
                    section.className = 'test-section success';
                    result.innerHTML = `
                        <h4>‚úÖ Backend Server Connected</h4>
                        <p><strong>Server Status:</strong> ${data.message}</p>
                        <p><strong>Timestamp:</strong> ${data.timestamp}</p>
                        <p><strong>API Base URL:</strong> ${API_BASE}</p>
                    `;
                    return true;
                } else {
                    throw new Error('Server returned error');
                }
            } catch (error) {
                const section = document.getElementById('database-status');
                const result = document.getElementById('database-result');
                section.className = 'test-section error';
                result.innerHTML = `
                    <h4>‚ùå Connection Failed</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Make sure the Node.js backend server is running on port 3000</p>
                `;
                return false;
            }
        }

        async function loadAllInterests() {
            try {
                const response = await fetch(`${API_BASE}/interests`);
                const data = await response.json();
                
                const section = document.getElementById('interests-overview');
                const result = document.getElementById('interests-result');
                
                if (data.success) {
                    globalInterests = data.interests;
                    section.className = 'test-section success';
                    
                    const categorizedInterests = data.interests.categorizedInterests || {};
                    
                    // Update stats
                    const totalInterests = Object.values(categorizedInterests).flat().length;
                    const totalCategories = Object.keys(categorizedInterests).length;
                    document.getElementById('totalInterests').textContent = totalInterests;
                    document.getElementById('totalCategories').textContent = totalCategories;
                    
                    result.innerHTML = `
                        <h4>‚úÖ Enhanced Interests Database Loaded</h4>
                        <div class="interest-grid">
                            ${Object.entries(categorizedInterests).map(([category, interests]) => `
                                <div class="interest-category">
                                    <h4>${category.charAt(0).toUpperCase() + category.slice(1)} (${interests.length})</h4>
                                    <div class="interest-list">
                                        ${interests.map(interest => `<span class="interest-tag">${interest}</span>`).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <details style="margin-top: 15px;">
                            <summary>üìã Raw API Response</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            } catch (error) {
                const section = document.getElementById('interests-overview');
                const result = document.getElementById('interests-result');
                section.className = 'test-section error';
                result.innerHTML = `
                    <h4>‚ùå Failed to Load Interests</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
            }
        }

        async function loadContactAssignments() {
            try {
                const contactsResponse = await fetch(`${API_BASE}/contacts`);
                const contactsData = await contactsResponse.json();
                
                if (!contactsData.success) {
                    throw new Error('Failed to load contacts');
                }
                
                globalContacts = contactsData.contacts;
                document.getElementById('totalContacts').textContent = globalContacts.length;
                
                const section = document.getElementById('contacts-overview');
                const result = document.getElementById('contacts-result');
                
                let totalAssignments = 0;
                const contactCards = [];
                
                for (const contact of globalContacts) {
                    try {
                        const interestsResponse = await fetch(`${API_BASE}/contacts/${contact.ID}/interests`);
                        const interestsData = await interestsResponse.json();
                        
                        if (interestsData.success && interestsData.interests) {
                            const interests = interestsData.interests;
                            const assignmentCount = Object.values(interests).flat().length;
                            totalAssignments += assignmentCount;
                            
                            contactCards.push(`
                                <div class="contact-card">
                                    <div class="contact-name">${contact.Name} (ID: ${contact.ID})</div>
                                    <p><strong>Email:</strong> ${contact.email || 'Not provided'}</p>
                                    <p><strong>Phone:</strong> ${contact.phone || 'Not provided'}</p>
                                    <p><strong>Birthday:</strong> ${contact.birthday || 'Not provided'}</p>
                                    <p><strong>Total Interests:</strong> ${assignmentCount}</p>
                                    <div class="interest-grid">
                                        ${Object.entries(interests).map(([category, items]) => `
                                            <div class="interest-category">
                                                <h4>${category.charAt(0).toUpperCase() + category.slice(1)}</h4>
                                                <div class="interest-list">
                                                    ${items.map(item => `<span class="interest-tag">${item}</span>`).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `);
                        } else {
                            contactCards.push(`
                                <div class="contact-card">
                                    <div class="contact-name">${contact.Name} (ID: ${contact.ID})</div>
                                    <p><strong>Status:</strong> ‚ö†Ô∏è No interests assigned in database</p>
                                </div>
                            `);
                        }
                    } catch (error) {
                        contactCards.push(`
                            <div class="contact-card">
                                <div class="contact-name">${contact.Name} (ID: ${contact.ID})</div>
                                <p><strong>Error:</strong> ${error.message}</p>
                            </div>
                        `);
                    }
                }
                
                document.getElementById('totalAssignments').textContent = totalAssignments;
                
                section.className = 'test-section success';
                result.innerHTML = `
                    <h4>‚úÖ Contact Interest Assignments Loaded</h4>
                    <p>Found ${globalContacts.length} contacts with ${totalAssignments} total interest assignments</p>
                    ${contactCards.join('')}
                `;
                
            } catch (error) {
                const section = document.getElementById('contacts-overview');
                const result = document.getElementById('contacts-result');
                section.className = 'test-section error';
                result.innerHTML = `
                    <h4>‚ùå Failed to Load Contact Assignments</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
            }
        }

        async function testContactSpecific(contactId) {
            try {
                const response = await fetch(`${API_BASE}/contacts/${contactId}/interests`);
                const data = await response.json();
                
                const result = document.getElementById('verification-result');
                
                if (data.success) {
                    result.innerHTML += `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <h4>‚úÖ Contact ID ${contactId} - Database Interests Retrieved</h4>
                            <pre>${JSON.stringify(data.interests, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    result.innerHTML += `
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <h4>‚ùå Contact ID ${contactId} - No Database Interests</h4>
                            <p>${data.message || 'No interests found in database'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                const result = document.getElementById('verification-result');
                result.innerHTML += `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin: 10px 0; border-radius: 5px;">
                        <h4>‚ùå Contact ID ${contactId} - API Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function verifyAllInterests() {
            document.getElementById('verification-result').innerHTML = '<p>üîÑ Refreshing all data...</p>';
            
            await checkDatabaseConnection();
            await loadAllInterests();
            await loadContactAssignments();
            
            document.getElementById('verification-result').innerHTML = '<p>‚úÖ All data refreshed successfully!</p>';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Starting complete database interests verification...');
            await verifyAllInterests();
        });
    </script>
</body>
</html>